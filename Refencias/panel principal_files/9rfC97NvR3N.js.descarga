if (self.CavalryLogger) { CavalryLogger.start_js(["t4zxI"]); }

__d("MMessages",["CSS","DOM","MDateString","MessengerSupportedEmoji","MInViewportManager","MLegacyDataStore","MMessagesNewMessageBlockRenderer","MMessagesNewTextMessageRenderer","MMessagesReadReceipts","MMessagesReadReceiptsDOM","MMessageUtils","MOrionAttachmentBody","MP2PNUXRendererUtils","MReactComponentRenderer","MSuggestionPopup.react","MViewport","UserAgent","$","clearTimeout","gkx","setTimeoutAcrossTransitions"],(function(a,b,c,d,e,f){"use strict";var g=b("MOrionAttachmentBody").module,h=b("UserAgent").isBrowser("Facebook Messenger"),i=62,j=86,k=b("gkx")("1539623"),l="sugg-container",m="suggested_reply_location";a=function(){function a(a){this._user=a.userID,this._pageID=a.pageID,this._messageSubject=a.messageSubject,this._messageThreadID=a.messageThreadID,this._messageOtherUserFBID=a.messageOtherUserFBID,this._messageThreadFBID=a.messageThreadFBID,a.isCanonicalThread&&(this._typingIndicator=a.typingIndicatorElement),this._usersProfileUri=a.usersProfileUri,this._usersShortNames=a.usersShortNames,this._parseEmoticons=a.parseEmoticons,this._downloadLink=a.downloadLink,this._orcaPromotionBoxVisible=!1,this._showPrimWebviewRedesign=Boolean(a==null?void 0:a.showPrimWebviewRedesign)}var c=a.prototype;c.handleUserTyping=function(a){if(!b("gkx")("1416941"))return;a=a.getData();this._typingIndicator&&a.from==this._messageSubject&&(b("DOM").show(this._typingIndicator),b("clearTimeout")(this._deferredHide),this._deferredHide=b("setTimeoutAcrossTransitions")(function(){this._typingIndicator&&b("DOM").hide(this._typingIndicator)}.bind(this),4e3))};c.handlePageLoad=function(){k&&this._scrollSuggestionIntoView(),this._scrollLastMessageIntoViewIfNecessary()};c.handleModuleLoad=function(){k&&this._scrollSuggestionIntoView(),this._scrollLastMessageIntoViewIfNecessary()};c._scrollSuggestionIntoView=function(){document.getElementById(l)&&b("$")(l).scrollIntoView()};c._removeSuggestionPopup=function(){document.getElementById(l)&&b("DOM").remove(b("$")(l))};c._createSuggestionPopup=function(a){var c;this._removeSuggestionPopup();var d=b("DOM").create("div",{id:l});b("DOM").appendContent(b("$")("messageGroup"),[d]);(c=document.getElementById(l))==null?void 0:c.setAttribute("style","display: flex; justify-content: center; text-align: center;");b("MReactComponentRenderer")(b("MSuggestionPopup.react"),d,{suggestedReply:a});this._scrollSuggestionIntoView()};c.handleMessageReceived=function(a){a=a.getData();if(a.event==="read_receipt"&&a.is_sync){this._readReceipts(a);return}if(k){var c,d;c=(((c=a.message)==null?void 0:c.body)!==null||((c=a.message)==null?void 0:c.type)==="messaging")&&((c=a.message)==null?void 0:c.is_unread)===!1;if((d=a.message)==null?void 0:(d=d.meta_ranges)==null?void 0:(d=d.data)==null?void 0:d.m_suggestion_data){d=JSON.parse((d=a.message)==null?void 0:(d=d.meta_ranges)==null?void 0:(d=d.data)==null?void 0:d.m_suggestion_data);if(Object.prototype.hasOwnProperty.call(d,m)){d=d[m];this._createSuggestionPopup(d)}}else c&&this._removeSuggestionPopup()}d=a.parsedPayload;c=a.targetFBID;if(!d||!this._payloadIsForThisThread(d,c)||this._alreadyHasMessage(d.getUUID()))return;this._typingIndicator&&(b("clearTimeout")(this._deferredHide),b("DOM").hide(this._typingIndicator));b("MMessagesReadReceiptsDOM").clearAll();a=this._addNewMessage(d);a instanceof HTMLElement&&(this._showPrimWebviewRedesign?a.scrollIntoView():(b("CSS").conditionClass(a,"chatHighlight",!0),b("MViewport").scrollToNode(b("$")("composerInput"))))};c._scrollLastMessageIntoViewIfNecessary=function(){if(this._showPrimWebviewRedesign){var a=b("DOM").scry(b("$")("messageGroup"),"div","message-xhp").pop(),c=h?j:i;a&&!b("MInViewportManager").isInViewport(a,-c)&&a.scrollIntoView()}};c._payloadIsForThisThread=function(a,b){if(this._pageID&&this._pageID!=b)return!1;if(this._messageOtherUserFBID!==null)return this._messageOtherUserFBID===a.getOtherUserFBID();else if(this._messageThreadFBID!==null)return this._messageThreadFBID===a.getThreadFBID();return!1};c._addNewMessage=function(a){var c=b("DOM").scry(b("$")("messageGroup"),"div","message-xhp").pop();if(this._shouldCreateNewMessageBlock(c,a)){var d={author_href:this._usersProfileUri[a.getAuthorFBID()],page_id:this._pageID,should_parse_emoticons:this._parseEmoticons,user:this._user,download_link:this._downloadLink,is_supported_emoji:b("MessengerSupportedEmoji").isSupportedEmoji,get_messenger_emote:b("MessengerSupportedEmoji").getMessengerEmote,show_prim_webview_redesign:this._showPrimWebviewRedesign};d=b("MMessagesNewMessageBlockRenderer")(a,d);var e={name:a.getAuthorName(),attachment_count:a.getAttachmentCount(),message_source:this._showPrimWebviewRedesign?null:a.getMessageSource()};b("MLegacyDataStore").set(d,e);this._setTimestamp(d);e=b("DOM").scry(d,"img","attachment-image");e.forEach(function(a){a.addEventListener("load",function(){b("MViewport").scrollToNode(b("$")("composerInput"))})});e=b("DOM").find(d,"div","message-text");e.setAttribute("data-testid","message-block");b("MLegacyDataStore").set(e,this._getMessageTextData(a));b("DOM").appendContent(b("$")("messageGroup"),d);e=this._createSystemNewMessageBlock(a);e&&b("DOM").appendContent(b("$")("messageGroup"),e);!this._orcaPromotionBoxVisible&&this._orcaPromotionBox&&this._shouldDisplayOrcaPromotionBox(a)&&(b("DOM").show(this._orcaPromotionBox),this._orcaPromotionBoxVisible=!0);e=d}else e=this._addMessageToExisting(c,a);return e};c._shouldDisplayOrcaPromotionBox=function(a){return(a.getMessageSource()==="source:chat:orca"||a.getMessageSource()==="source:titan:orca")&&a.getAuthorFBID()!==this._user?!0:!1};c._shouldCreateNewMessageBlock=function(a,c){if(!a)return!0;a=b("MLegacyDataStore").get(a);if(b("MMessageUtils").getMessageSourceText(a.message_source)!=b("MMessageUtils").getMessageSourceText(c.getMessageSource()))return!0;return a.name==c.getAuthorName()&&!a.attachment_count&&!c.getAttachmentCount()?!1:!0};c._readReceipts=function(a){a=Object.keys(a.message.roger)[0];if(a!==(this._messageOtherUserFBID||this._messageThreadFBID))return;b("MMessagesReadReceiptsDOM").clearAll();a=b("DOM").scry(b("$")("messageGroup"),"div","message-text").reverse();var c=a.map(function(a){return b("MLegacyDataStore").get(a)}),d=this._pageID||this._user,e={};e[d]=!0;for(var d=0,f;f=c[d];d++){e[f.author]=!0;f=b("MMessagesReadReceipts").getSeenBy(this._messageOtherUserFBID?this._messageOtherUserFBID:this._messageThreadFBID,parseInt(f.timestamp,10),Object.keys(e));for(var g in f)e[g]=!0;if(Object.keys(f).length){var h={users_short_names:this._usersShortNames,user:this._user};b("MMessagesReadReceiptsDOM").addNew(a[d],c[d],f,h)}}};c._alreadyHasMessage=function(a){if(a){var c=b("DOM").scry(b("$")("messageGroup"),"div","message-text");for(var d=0,e;e=c[d];d+=1){e=b("MLegacyDataStore").get(e);if(e.uuid==a)return!0}}return!1};c._getMessageTextData=function(a){return{author:a.getAuthorFBID(),timestamp:a.getTimestamp(),uuid:a.getUUID()}};c._addMessageToExisting=function(a,c){a=b("DOM").find(a,"span","message-body").parentNode;var d={should_parse_emoticons:this._parseEmoticons,is_supported_emoji:b("MessengerSupportedEmoji").isSupportedEmoji,get_messenger_emote:b("MessengerSupportedEmoji").getMessengerEmote,user:this._user,show_prim_webview_redesign:this._showPrimWebviewRedesign};d=b("MMessagesNewTextMessageRenderer")(c,d);b("MLegacyDataStore").set(d,this._getMessageTextData(c));b("DOM").appendContent(a,d);return d};c._createSystemNewMessageBlock=function(a){var c=null;if(g){a=b("MP2PNUXRendererUtils").getTransferFromAttachments((a.getAttachments()||[]).map(function(a){return(a=a)!=null?a.extensible_attachment:a}).filter(Boolean));if(a){a={transactionId:a.transfer_id,senderId:a.sender.id};c=g.createNUX(a,function(){return b("MViewport").scrollToNode(b("$")("composerInput"))})}}return c};c._setTimestamp=function(a){a=b("DOM").find(a,"abbr","timestamp");a.setAttribute("data-meta",null);var c=Math.floor(Date.now()/1e3);b("MLegacyDataStore").set(a,{time:c});b("DOM").setContent(a,b("MDateString").displayTime(c))};return a}();Object.assign(a.prototype,{_user:null,_deferredHide:null,_messageSubject:null,_messageThreadID:null,_messageOtherUserFBID:null,_messageThreadFBID:null,_typingIndicator:null,_usersProfileUri:null,_usersShortNames:null});e.exports=a}),null);